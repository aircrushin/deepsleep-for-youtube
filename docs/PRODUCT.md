# DeepSleep Tube 产品文档

## 目录

- [一、需求评估](#一需求评估)
  - [1.1 问题发现](#11-问题发现)
  - [1.2 用户画像](#12-用户画像)
  - [1.3 竞品分析与差异化](#13-竞品分析与差异化)
  - [1.4 核心需求提炼](#14-核心需求提炼)
  - [1.5 需求优先级矩阵](#15-需求优先级矩阵)
- [二、产品形态设计](#二产品形态设计)
  - [2.1 为什么是 Chrome 扩展](#21-为什么是-chrome-扩展)
  - [2.2 交互设计理由](#22-交互设计理由)
  - [2.3 预设系统设计](#23-预设系统设计)
  - [2.4 视觉风格选择](#24-视觉风格选择)
  - [2.5 功能边界定义](#25-功能边界定义)
- [三、技术架构设计](#三技术架构设计)
  - [3.1 架构总览](#31-架构总览)
  - [3.2 音频处理链设计](#32-音频处理链设计)
  - [3.3 关键技术选型理由](#33-关键技术选型理由)
  - [3.4 通信架构](#34-通信架构)
  - [3.5 性能与资源约束](#35-性能与资源约束)
  - [3.6 已知限制与未来方向](#36-已知限制与未来方向)

---

## 一、需求评估

### 1.1 问题发现

许多人习惯在睡前听 YouTube 上的白噪音、ASMR、播客或有声书来辅助入睡。然而，YouTube 的原始音频体验存在以下**核心痛点**：

| 痛点 | 场景描述 | 影响程度 |
|------|---------|---------|
| **突发噪音惊醒** | 视频中突然出现的笑声、掌声、爆炸音效、广告，打断已入睡或半睡眠状态 | 致命 |
| **高频刺耳音** | 齿音、尖锐人声、金属碰撞声等高频成分让人烦躁不安 | 高 |
| **语速过快** | 某些播客/有声书朗读速度较快，不利于放松入睡 | 中 |
| **广告干扰** | YouTube 广告突然以高音量插入，严重破坏睡眠环境 | 高 |
| **静默焦虑** | 视频中的长时间静默让人产生"是否还在播放"的焦虑 | 低-中 |
| **不同视频音量差异大** | 切换视频后音量骤变 | 中 |

**核心洞察**：现有的音频处理工具（如 EQ 均衡器扩展）面向音乐爱好者设计，不是"睡眠"这一特定场景。市场缺少一个**专为"听着 YouTube 入睡"设计的音频解决方案**。

### 1.2 用户画像

**主要用户**：有听 YouTube 入睡习惯的人群

| 画像维度 | 描述 |
|---------|------|
| 使用场景 | 睡前 30 分钟 ~ 2 小时，手机/平板/电脑播放 YouTube |
| 典型内容 | ASMR、白噪音、雨声、播客、有声书、lo-fi 音乐、冥想引导 |
| 核心诉求 | "不被吵醒"，"听着舒服就行"，"不想操心设置" |
| 技术水平 | 不需要理解音频参数，只需开关和简单预设 |
| 使用频率 | 每天或隔天使用 |

**次要用户**：
- 对声音敏感的人（如高敏感人群 HSP）
- 有听觉过敏症状的人
- 需要安静学习环境、想过滤背景噪音的人

### 1.3 竞品分析与差异化

| 维度 | YouTube Premium | 通用 EQ 扩展 | 白噪音 App | **DeepSleep Tube** |
|------|----------------|-------------|-----------|-------------------|
| 去广告 | ✅ 完全去除 | ❌ | N/A | ✅ 广告静音 |
| 音频峰值抑制 | ❌ | ❌ | N/A | ✅ 5ms 响应 |
| 暖音滤波 | ❌ | ⚠️ 手动 EQ | N/A | ✅ 一键预设 |
| 变速播放 | ✅ | ❌ | N/A | ✅ 变速不变调 |
| 睡眠定时器 | ❌ | ❌ | ✅ | ✅ 带智能淡出 |
| 舒适噪音 | ❌ | ❌ | ✅ 核心功能 | ✅ 粉红噪音 |
| 定价 | ¥54/月 | 免费 | ¥30-50 一次性 | **免费** |

**差异化定位**：DeepSleep Tube 不是通用音频工具，而是**第一个专为"YouTube 睡眠场景"设计的一体化解决方案**。它把多个分散的功能（压缩器 + 滤波 + 变速 + 定时器 + 噪音机）整合到一个轻量级扩展中。

### 1.4 核心需求提炼

从用户痛点出发，提炼出**六个核心功能需求**：

```
用户痛点                →    产品功能
─────────────────────────────────────────────────
突发噪音惊醒            →    智能动态压缩（Safety）
高频刺耳音              →    暖音滤波器（Warmth）
语速过快                →    变速不变调（Speed）
广告干扰                →    广告自动静音（Ad Mute）
静默焦虑                →    粉红噪音填充（Comfort Noise）
不知道何时关机           →    睡眠计时器 + 智能淡出（Timer）
```

以及**两个体验需求**：

- **零配置即可用**：提供"开箱即用"的预设（Deep Sleep / Zen / Relax），一键切换
- **睡眠场景友好 UI**：OLED 纯黑界面，低亮度不刺眼

### 1.5 需求优先级矩阵

使用 MoSCoW 方法划分优先级：

| 优先级 | 功能 | 理由 |
|--------|------|------|
| **Must have** | 动态压缩（防惊吓） | 最核心的痛点，没有它产品无意义 |
| **Must have** | 暖音滤波 | 仅次于防惊吓的刚需 |
| **Must have** | 一键预设 | 用户不想理解参数 |
| **Should have** | 广告静音 | 高频痛点，但非 YouTube Premium 用户专属 |
| **Should have** | 睡眠计时器 + 淡出 | 重要的完整体验 |
| **Should have** | 变速不变调 | 部分用户需要 |
| **Could have** | 粉红噪音 | 锦上添花 |
| **Could have** | 自定义预设 | 高级用户需求 |
| **Could have** | 音量 dB 控制 | 精细调节 |
| **Won't have (v1)** | AI 语音检测 | 技术复杂度过高 |
| **Won't have (v1)** | 频谱可视化 | 非核心体验 |

---

## 二、产品形态设计

### 2.1 为什么是 Chrome 扩展

在确定产品形态时，评估了以下方案：

| 方案 | 优势 | 劣势 | 结论 |
|------|------|------|------|
| **Chrome 扩展** | 零安装门槛、直接操控页面音频、原生 Web Audio API | 仅限 Chrome/Edge | ✅ 选择 |
| 独立桌面应用 | 跨浏览器 | 需要系统级音频驱动，安装复杂 | ❌ 过重 |
| 油猴脚本 | 轻量 | 无独立 UI，AudioWorklet 受限，分发困难 | ❌ 能力不足 |
| Web App | 跨平台 | 无法捕获其他标签页音频 | ❌ 不可行 |

**选择 Chrome 扩展的核心理由**：

1. **直接访问 `<video>` 元素**：Content Script 可以直接获取 YouTube 页面的 `video.html5-main-video` 元素，通过 `MediaElementAudioSourceNode` 无损接管音频流
2. **Web Audio API 原生支持**：浏览器内置的音频处理能力足以实现所有需求功能，无需额外依赖
3. **Manifest V3 生态成熟**：现代扩展架构，安全性好，审核友好
4. **用户心智模型匹配**："在浏览器里装个插件"对目标用户来说是零门槛操作

### 2.2 交互设计理由

#### 2.2.1 Popup（弹窗）作为主控面板

**为什么不用 Side Panel / Options Page / 注入式面板？**

| 方案 | 评估 |
|------|------|
| Popup 弹窗 | ✅ 点击图标立即出现，操作后自动收起，符合"快速调一下"的使用心智 |
| Side Panel | ❌ 占用屏幕空间，睡前用户不需要持续盯着面板 |
| Options Page | ❌ 新开标签页，操作路径过长 |
| 注入页面 | ❌ 与 YouTube UI 耦合，适配成本高 |

Popup 的设计哲学是：**打开 → 调整 → 关闭 → 睡觉**。它不需要常驻界面。

#### 2.2.2 月亮图标注入 YouTube 播放器

在 YouTube 播放器右下角注入一个 🌙 按钮（通过 Content Script + CSS），目的是：

- **状态反馈**：让用户在全屏模式下也能知道 DeepSleep 正在工作
- **数据展示**：Hover 显示"已抑制 X 个峰值"，给用户信心（"它确实在保护我"）
- **原生融合**：按钮样式与 YouTube 控制栏一致，不突兀

#### 2.2.3 滑块而非数字输入

所有参数（Safety / Warmth / Speed / Volume）使用滑块控制，原因：

- 睡前操作场景，手指/鼠标**粗粒度滑动**比精确输入更友好
- 参数含义对用户不透明（"压缩器阈值 -30dB"没有意义），滑块 + 百分比标签更直觉
- 实时预览：`input` 事件实时调参，`change` 事件才持久化，用户可以边听边调

### 2.3 预设系统设计

#### 2.3.1 三个内置预设

预设是降低用户认知负担的关键设计：

| 预设 | Safety | Warmth | Speed | 设计意图 |
|------|--------|--------|-------|---------|
| 😴 Deep Sleep | 90% | 85% | 0.90x | 最大程度过滤，适合"我什么都不想听到" |
| 🍃 Zen | 80% | 72% | 0.95x | 平衡模式，适合冥想/轻度放松 |
| 🧘 Relax | 70% | 60% | 1.00x | 最轻度过滤，接近原声但更安全 |

**设计原则**：
- 渐进式体验：Relax → Zen → Deep，用户可以逐步加深
- 三个足够，不多不少——避免选择困难症
- 命名用情感词汇（Deep Sleep / Zen / Relax）而非技术词汇（High / Medium / Low）

#### 2.3.2 自定义预设

面向高级用户开放自定义预设能力：
- 调好参数后点击 `+ Save Current` 保存
- 存储在 `chrome.storage.local`，独立于内置预设
- 支持删除，不支持编辑（降低实现和交互复杂度，重新保存即可覆盖）

**设计取舍**：自定义预设只保存 Safety / Warmth / Speed 三个参数，不保存 Volume / Ad Mute / Comfort Noise，因为后三者更多是"环境设置"而非"音色偏好"。

### 2.4 视觉风格选择

**OLED 纯黑主题**（背景 `#000`，高亮色 `#a78bfa` 紫色）

设计理由：
1. **睡眠场景**：深夜使用，纯黑减少屏幕光线对眼睛的刺激
2. **OLED 友好**：OLED 屏幕纯黑像素不发光，真正的"零亮度"
3. **紫色调**：紫色是"夜间"和"安眠"的色彩心理暗示（薰衣草、夜空），与产品定位一致
4. **低对比度文字**：非焦点文字使用 `#555` ~ `#888`，避免高对比刺眼

### 2.5 功能边界定义

明确不做的事情（及其理由）：

| 不做 | 理由 |
|------|------|
| 去除广告 | 涉及 YouTube 政策风险，仅做"静音"处理 |
| 支持 YouTube 嵌入页 | Content Script 的 host_permissions 限定 youtube.com，嵌入页域名不可控 |
| 跨设备同步预设 | v1 版本使用 `chrome.storage.local` 而非 `sync`，避免同步冲突 |
| 后台播放 | 超出音频过滤的产品边界 |
| 支持其他视频网站 | 聚焦 YouTube 做深，避免 DOM 适配成本 |

---

## 三、技术架构设计

### 3.1 架构总览

```
┌─────────────────────────────────────────────────────────┐
│                  Chrome Extension (Manifest V3)          │
├──────────────┬─────────────────┬─────────────────────────┤
│   Popup UI   │  Background SW  │    Content Script        │
│  popup.html  │ background.js   │    content.js            │
│  popup.js    │  (Service       │   (DeepSleepAudio 类)    │
│  popup.css   │   Worker)       │    content.css           │
│              │                 │    pink-noise-processor.js│
│  职责:       │  职责:          │    职责:                 │
│  设置界面    │  安装初始化     │    音频处理引擎          │
│  预设管理    │  Badge 更新     │    DOM 观察              │
│  消息发送    │  设置中转       │    广告检测              │
└──────────────┴─────────────────┴─────────────────────────┘
```

**三层分离的设计理由**：

- **Popup**：负责 UI 和用户交互。生命周期短暂（关闭即销毁），不持有音频状态
- **Background (Service Worker)**：负责扩展级生命周期事件（安装、Badge），Manifest V3 强制要求
- **Content Script**：注入 YouTube 页面，直接操作 DOM 和 Web Audio API。这是核心引擎所在

### 3.2 音频处理链设计

```
video.html5-main-video
        │
        ▼
MediaElementAudioSourceNode ← 无损捕获视频音频流
        │
        ▼
DynamicsCompressorNode      ← 第一道防线：峰值压缩
        │
        ▼
BiquadFilterNode (lowpass)  ← 第二道处理：高频衰减
        │
        ▼
GainNode                    ← 第三道处理：淡出/广告静音
        │
        ▼
VolumeGainNode              ← 第四道处理：用户音量调节
        │
        ▼
AudioDestinationNode        → 扬声器

  并行路径:
  AudioWorkletNode (pink noise) → GainNode → AudioDestinationNode
```

**处理链顺序的设计理由**：

1. **压缩器在最前面**：峰值必须在第一时间被捕获和抑制，如果放在滤波器之后，高频峰值可能已被滤除但中低频峰值仍然通过
2. **低通滤波在压缩之后**：压缩后的信号再做频率整形，避免压缩器对滤波后信号产生不自然的"泵浦效应"（pumping）
3. **Gain 节点在滤波之后**：统一控制最终音量，不影响前级处理效果
4. **Volume Gain 独立于 Fade Gain**：音量控制（用户主动调节）和淡出控制（定时器自动）互不干扰。两个 GainNode 分开，避免淡出过程中用户调音量导致状态混乱
5. **粉红噪音独立路径**：不经过压缩和滤波链，因为粉红噪音是已知的恒定信号，不需要被处理

### 3.3 关键技术选型理由

#### 3.3.1 Web Audio API vs. 其他方案

| 方案 | 评估 |
|------|------|
| **Web Audio API** | ✅ 浏览器原生、硬件加速、<5ms 延迟、无需额外库 |
| WebAssembly + FFmpeg | ❌ 包体过大（~2MB+），Chrome 扩展审核敏感 |
| ScriptProcessorNode | ❌ 已废弃，主线程处理会造成卡顿 |
| 第三方音频库（Tone.js） | ❌ 增加依赖，DeepSleep 只需原生节点 |

**选择 Web Audio API 的决定性因素**：`DynamicsCompressorNode` 和 `BiquadFilterNode` 都是浏览器原生节点，底层由 C++ 实现，性能远超 JavaScript 级处理。对于本产品的需求，完全不需要引入额外库。

#### 3.3.2 AudioWorklet vs. ScriptProcessorNode

粉红噪音生成使用了 `AudioWorklet`（通过 `pink-noise-processor.js`）：

| 维度 | ScriptProcessorNode | AudioWorklet |
|------|-------------------|-------------|
| 执行线程 | 主线程 | 独立音频线程 |
| 延迟 | 高（buffer 依赖） | 低（128 样本/帧） |
| 状态 | 已废弃（deprecated） | 现代标准 |
| 实现位置 | Content Script 内 | 独立 .js 文件 |

选择 AudioWorklet 的理由：避免在主线程做逐样本计算，消除音频 glitch 和页面卡顿的风险。

**代价**：AudioWorklet 文件需要通过 `chrome.runtime.getURL()` 加载，并在 `manifest.json` 的 `web_accessible_resources` 中声明。这增加了一点配置复杂度，但保证了正确性。

#### 3.3.3 Voss-McCartney 粉红噪音算法

粉红噪音（1/f 噪音）的频谱特征是每倍频程能量递减 3dB，听感比白噪音更温暖自然。

选择 Voss-McCartney 算法的理由：
- **计算量极小**：每个样本只需 7 次乘法和 7 次加法
- **音质优秀**：7 级级联滤波器产生的粉红噪音频谱偏差 < 0.5dB
- **无需预计算**：不需要 FFT/IFFT，适合逐样本实时处理

#### 3.3.4 Manifest V3 而非 V2

- **强制要求**：Chrome 已逐步淘汰 Manifest V2，新扩展必须使用 V3
- **安全性**：V3 的 Service Worker 不持久化运行，减少资源占用
- **最小权限**：仅申请 `storage`（设置持久化）和 `activeTab`（当前标签页访问），不申请 `tabs` 等宽泛权限

#### 3.3.5 参数映射设计

将用户友好的 0-100% 滑块映射到专业音频参数：

```
Safety (0-100%)  →  threshold:  -50 + (safety × 0.4)     = -50dB ~ -10dB
                    ratio:      4 + (safety × 0.16)       = 4:1 ~ 20:1
                    attack:     0.001 + (0.004 × (100 - safety) / 100) = 1ms ~ 5ms
                    release:    0.05 + (0.2 × (100 - safety) / 100)   = 50ms ~ 250ms

Warmth (0-100%)  →  frequency:  8000 - (warmth × 60)     = 8000Hz ~ 2000Hz
                    Q:          0.7 (固定)

Speed (70-100)   →  playbackRate: speed / 100             = 0.7x ~ 1.0x

Volume (-30~+6)  →  linearGain:  10^(volumeDb / 20)      = 0.032 ~ 2.0
```

**设计理由**：用户不需要理解 dB、压缩比、截止频率等概念。一个"Safety"滑块背后映射了 4 个压缩器参数，一个"Warmth"滑块映射了滤波器频率。用户只需感受效果并调节。

### 3.4 通信架构

```
Popup ──(chrome.tabs.sendMessage)──→ Content Script
           SETTINGS_UPDATE             applySettings()
           GET_STATS                   → sendResponse()

Popup ←──(chrome.storage.local)──→ Background SW
           读取/写入设置                监听 onChanged → 更新 Badge
```

**设计要点**：

1. **Popup → Content 使用消息传递（而非 Storage 监听）**

   理由：设置更新需要**立即生效**。如果用 `chrome.storage.onChanged` 监听，存在不确定的延迟。`chrome.tabs.sendMessage` 是同步消息传递，延迟 < 1ms。

2. **设置持久化使用 `chrome.storage.local`**

   理由：`chrome.storage.sync` 有 100KB 上限和写入频率限制（每秒 2 次），用户频繁拖拽滑块时可能触发限流。`local` 没有这些限制。

3. **Content Script 启动时主动从 Storage 读取**

   理由：Content Script 的生命周期独立于 Popup。YouTube SPA 导航时 Content Script 可能重新注入，此时 Popup 未打开，必须能从 Storage 恢复上次设置。

### 3.5 性能与资源约束

| 指标 | 目标 | 实现方式 |
|------|------|---------|
| 音频处理延迟 | < 20ms | 全部使用原生 AudioNode，硬件加速 |
| CPU 占用 | < 2% | 无 JavaScript 级逐样本处理（AudioWorklet 在独立线程） |
| 内存占用 | < 5MB | 无大型缓冲区，节点图常驻 |
| 首次激活时间 | < 100ms | AudioContext 创建 + 节点连接同步完成 |

**关键优化决策**：

- **峰值监测使用 `requestAnimationFrame`** 而非 `setInterval`：与渲染帧率同步，避免不必要的高频轮询
- **广告检测使用 `MutationObserver`** + 500ms `setInterval` 双保险：MutationObserver 捕获 DOM 变化，setInterval 兜底防止遗漏
- **视频元素发现使用 `MutationObserver`** + 2s `setInterval`：处理 YouTube SPA 路由跳转时的视频元素重建
- **节点复用**：`detach` 时只断开连接不销毁节点，`reattach` 时重连，避免重复创建 AudioContext（每个 `<video>` 只能创建一个 `MediaElementAudioSourceNode`）

### 3.6 已知限制与未来方向

#### 已知限制

| 限制 | 原因 | 影响 |
|------|------|------|
| 仅限 youtube.com | Content Script 的 host_permissions 限制 | 嵌入式 YouTube 播放器不生效 |
| 页面导航需重新注入 | YouTube SPA 路由变化时 | 已通过 2s 轮询缓解 |
| 需要用户手势激活 AudioContext | Chrome 自动播放策略 | 用户第一次点击 Popup 开关即触发 |
| 自定义预设不跨设备同步 | 使用 chrome.storage.local | 仅本机可用 |

#### 未来迭代方向

| 方向 | 价值 | 复杂度 |
|------|------|--------|
| AI 语音/音乐分类 | 区分人声与背景音，针对性处理 | 高（需 TensorFlow.js 模型） |
| LUFS 响度标准化 | 跨视频一致音量体验 | 中（需 AnalyserNode + 算法） |
| 频谱可视化 | 让用户"看到"处理效果 | 低-中 |
| 自定义 EQ 曲线 | 高级用户精细控制 | 中 |
| Firefox 适配 | 扩大用户群 | 中（Manifest 差异处理） |
| chrome.storage.sync 迁移 | 跨设备同步预设 | 低 |

---

*最后更新：2026-02-06*
